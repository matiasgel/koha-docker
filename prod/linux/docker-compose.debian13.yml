version: '3.8'

services:
  koha:
    image: teogramm/koha:24.11
    container_name: koha-production
    restart: unless-stopped
    ports:
      - "${KOHA_OPAC_PORT:-8080}:8080"
      - "${KOHA_STAFF_PORT:-8081}:8081"
    environment:
      - MYSQL_SERVER=mariadb
      - MYSQL_USER=${KOHA_DB_USER}
      - MYSQL_PASSWORD=${KOHA_DB_PASSWORD}
      - DB_NAME=${KOHA_DB_NAME}
      - MEMCACHED_SERVERS=memcached:11211
      - MB_HOST=rabbitmq
      - KOHA_LANGS=${KOHA_LANGS:-es-ES}
      - KOHA_INSTANCE=${KOHA_INSTANCE:-biblioteca}
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - koha_etc:/etc/koha
      - koha_var:/var/lib/koha
      - koha_logs:/var/log/koha
      - koha_uploads:/var/lib/koha/uploads
      - koha_covers:/var/lib/koha/covers
      - ./config/koha:/etc/koha/sites:ro
    depends_on:
      mariadb:
        condition: service_healthy
      memcached:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    networks:
      - koha-network
    deploy:
      resources:
        limits:
          memory: ${KOHA_MEMORY_LIMIT:-2g}
          cpus: '${KOHA_CPU_LIMIT:-2}'
        reservations:
          memory: 512m
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  mariadb:
    image: mariadb:11
    container_name: koha-mariadb
    restart: unless-stopped
    environment:
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${KOHA_DB_NAME}
      - MARIADB_USER=${KOHA_DB_USER}
      - MARIADB_PASSWORD=${KOHA_DB_PASSWORD}
      - MARIADB_CHARACTER_SET_SERVER=utf8mb4
      - MARIADB_COLLATION_SERVER=utf8mb4_unicode_ci
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./config/mariadb/my.cnf:/etc/mysql/conf.d/koha.cnf:ro
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
      - mariadb_logs:/var/log/mysql
    ports:
      - "127.0.0.1:${MYSQL_PORT:-3306}:3306"
    command: >
      --innodb-buffer-pool-size=${MYSQL_INNODB_BUFFER_POOL_SIZE:-1G}
      --max-connections=${MYSQL_MAX_CONNECTIONS:-200}
      --innodb-log-file-size=${MYSQL_INNODB_LOG_FILE_SIZE:-256M}
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=2
      --log-queries-not-using-indexes=1
    networks:
      - koha-network
    deploy:
      resources:
        limits:
          memory: ${DB_MEMORY_LIMIT:-2g}
          cpus: '${DB_CPU_LIMIT:-2}'
        reservations:
          memory: 512m
          cpus: '0.5'
    healthcheck:
      test: ["CMD", "mariadb-admin", "ping", "-h", "localhost", "-u", "root", "-p${MARIADB_ROOT_PASSWORD}"]
      interval: 30s
      timeout: 10s
      retries: 3

  memcached:
    image: memcached:1.6-alpine
    container_name: koha-memcached
    restart: unless-stopped
    command: memcached -m ${MEMCACHED_MEMORY:-256} -I 4m
    networks:
      - koha-network
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '0.5'

  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: koha-rabbitmq
    restart: unless-stopped
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_DEFAULT_USER:-pjnadmin_rabbit}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_DEFAULT_PASS}
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./config/rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins:ro
      - ./config/rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
    ports:
      - "127.0.0.1:${RABBITMQ_PORT:-5672}:5672"
      - "127.0.0.1:${RABBITMQ_MANAGEMENT_PORT:-15672}:15672"
    networks:
      - koha-network
    deploy:
      resources:
        limits:
          memory: 512m
          cpus: '1'
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  nginx:
    image: nginx:alpine
    container_name: koha-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx/sites/:/etc/nginx/conf.d/:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    depends_on:
      - koha
    networks:
      - koha-network
    deploy:
      resources:
        limits:
          memory: 256m
          cpus: '0.5'

  backup:
    image: alpine:3.18
    container_name: koha-backup
    restart: unless-stopped
    environment:
      - BACKUP_SCHEDULE=${BACKUP_SCHEDULE:-"0 2 * * *"}
      - BACKUP_RETENTION_DAYS=${BACKUP_RETENTION_DAYS:-30}
      - MYSQL_HOST=mariadb
      - MYSQL_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - TZ=${TIMEZONE:-UTC}
    volumes:
      - ${BACKUP_PATH:-./backups}:/backups
      - mariadb_data:/var/lib/mysql:ro
      - koha_etc:/etc/koha:ro
      - koha_var:/var/lib/koha:ro
      - ./scripts/backup.sh:/backup.sh:ro
    command: >
      sh -c "
        apk add --no-cache dcron mariadb-client gzip tar &&
        echo '${BACKUP_SCHEDULE:-0 2 * * *} /backup.sh' | crontab - &&
        crond -f"
    networks:
      - koha-network
    depends_on:
      - mariadb
    deploy:
      resources:
        limits:
          memory: 256m

volumes:
  mariadb_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/mariadb
  
  koha_etc:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/koha/etc
  
  koha_var:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/koha/var
  
  koha_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-/var/log/koha-docker}/koha
  
  koha_uploads:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/koha/uploads
  
  koha_covers:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/koha/covers
  
  rabbitmq_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/koha-docker/data}/rabbitmq
  
  mariadb_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-/var/log/koha-docker}/mariadb
  
  nginx_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${LOGS_PATH:-/var/log/koha-docker}/nginx

networks:
  koha-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16